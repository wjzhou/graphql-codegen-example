# graphql-codegen-example
A basic example to show how to use the graphql-codegen

## Nodejs server graphql
### define schema in [src/schema.graphql.ts](./packages/server/src/schema.graphql.ts)
Note: We are using ts file for the server, because the codegen only generate type information for server
### install codegen
```bash
$ npm install -D @graphql-codegen/cli @graphql-codegen/typescript @graphql-codegen/typescript-resolvers graphql
```
### add [codegen.yml](./packages/server/codegen.yml)
```yaml
overwrite: true
schema: "./src/schema.graphql.ts"
generates:
  src/types.ts:
    plugins:
      - typescript
      - typescript-resolvers
    config:
      contextType: ./context#Context
      scalars:
        Date: Date
```
Note: in order to give scalars more detailed type instead of `any`, the scalars need to be configured in config.

Also, the context part is optional but recommended. This tell the code-generate to import from './context.ts' for
Context type. 
### add scripts to [package.json](./packages/server/package.json)
```bash
"generate": "graphql-codegen --config codegen.yml"
"generate:w": "graphql-codegen -w --config codegen.yml"
```
### write resolvers.
[Sample](./packages/server/src/resolvers.ts)

## Client side (Apollo React Client)

### install codegen
```bash
$ npm install -D @graphql-codegen/cli @graphql-codegen/typescript @graphql-codegen/typescript-operations \
@graphql-codegen/near-operation-file-preset @graphql-codegen/typescript-react-apollo @graphql-codegen/fragment-matcher \
@graphql-codegen/typescript-apollo-client-helpers graphql
```
### define operations in `src/**/[ReactConponent].graphql`
Note: We are using graphql file for the client, because the codegen would generate the client code for us
1. [fragment defination](./packages/client/src/Search/User.graphql)
2. [query sample that use the fragment](./packages/client/src/Search/Search.graphql)

### add [codegen.yml](./packages/client/codegen.yml)
```yaml
overwrite: true
schema: "../server/src/schema.graphql.ts"
documents: 'src/**/*.graphql'
generates:
  src/apollo/types.ts:
    - typescript
  src/apollo/client-helpers.ts:
    plugins:
      - typescript-apollo-client-helpers
  src/apollo/possible-types.ts:
    plugins:
      - fragment-matcher
  src/:
    preset: near-operation-file
    presetConfig:
       baseTypesPath: apollo/types.ts
    plugins:
      - typescript-operations
      - typescript-react-apollo

```

### add scripts to [package.json](./packages/server/package.json)
```bash
"generate": "graphql-codegen --config codegen.yml"
"generate:w": "graphql-codegen -w --config codegen.yml"
```
### use Apollo
#### Provide context in [`app.ts`](./packages/client/src/App.tsx):
```tsx
import { ApolloProvider, ApolloClient, InMemoryCache } from '@apollo/client';
import possibleTypes from './apollo/possible-types';
import { TypedTypePolicies } from './apollo/client-helpers';

const typePolicies: TypedTypePolicies = {
  possibleTypes: possibleTypes.possibleTypes
}

const client = new ApolloClient({
  cache: new InMemoryCache({ typePolicies }),
  uri: "http://localhost:4000/graphql"
});

function App() {
  return (
    <ApolloProvider client={client}>
      <Search />
    </ApolloProvider>
  );
}
```
#### In component
1. [Query comoment example](./packages/client/src/Search/Search.tsx)
define query in .graphql file: [Search.graphql](./packages/client/src/Search/Search.graphql) 
```graphql
query search($term: String!){ # the generated function would be useSearchQuery
    search(term: $term) {
        __typename
        ...on User {
            ...UserFragment
        }
        ...on ChatMessage {
            id
            content
            time
            user {
                ...UserFragment
            }
        }
    }
}

```
Then, a client code is generated by codegen. [User.generated.ts](./packages/client/src/Search/Search.generated.ts)

In the [User.tsx]()./packages/client/src/Search/Search.tsx), you may use the query like this:
```const { loading, error, data } = useSearchQuery({ variables: { ... } });```

2. [Sub component under query example](./packages/client/src/Search/User.tsx)
define the fragment that is needed by the component [User.graphql](./packages/client/src/Search/User.graphql)
```graphql
fragment UserFragment on User {
    id
    username
    email
    role
}
```
In component, you may use the generated type information: [User.tsx](./packages/client/src/Search/User.tsx)
```import type { UserFragmentFragment } from './User.generated'```







